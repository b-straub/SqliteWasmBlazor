@page "/TestRunner"
@using SqliteWasmBlazor.TestApp.TestInfrastructure
@using Microsoft.EntityFrameworkCore
@using SqliteWasmBlazor.Models
@inject IDbContextFactory<TodoDbContext> DbContextFactory

<PageTitle>Test Runner</PageTitle>

<div>
    @if (_testsCompleted)
    {
        <h1>All Tests Completed</h1>
        <div>Passed: @_passedCount</div>
        <div>Failed: @_failedCount</div>
        @if (_failedTests.Any())
        {
            <h2>Failed Tests:</h2>
            @foreach (var (name, error) in _failedTests)
            {
                <div style="color: red">
                    <strong>@name</strong>: @error
                </div>
            }
        }
    }
    else
    {
        <h1>Running Tests...</h1>
        <div>Progress: @_completedTests / @_totalTests</div>
    }
</div>

@code {
    private bool _testsCompleted;
    private int _passedCount;
    private int _failedCount;
    private int _completedTests;
    private int _totalTests;
    private readonly List<(string Name, string Error)> _failedTests = new();

    protected override async Task OnInitializedAsync()
    {
        await RunAllTestsAsync();
    }

    private async Task RunAllTestsAsync()
    {
        var testFactory = new TestFactory(DbContextFactory);
        var tests = testFactory.GetTests().ToList();

        _totalTests = tests.Count;

        foreach (var (_, test) in tests)
        {
            await RunTestAsync(test.Name, async () =>
            {
                var result = await test.RunTestWithFreshDatabaseAsync();
                if (result is not null && result != "OK")
                {
                    throw new Exception(result);
                }
            });
            _completedTests++;
            StateHasChanged();
        }

        _testsCompleted = true;
        StateHasChanged();
    }

    private async Task RunTestAsync(string name, Func<Task> testFunc)
    {
        try
        {
            await testFunc();
            _passedCount++;
        }
        catch (Exception ex)
        {
            _failedCount++;
            _failedTests.Add((name, ex.Message));
        }
    }
}
