@page "/type-tests"
@using Microsoft.EntityFrameworkCore
@using System.Diagnostics
@using SqliteWasmBlazor.Models
@using SqliteWasmBlazor.Models.Models
@using SqliteWasmWorkerBridge = SqliteWasmBlazor.SqliteWasmWorkerBridge
@inject IDbContextFactory<TodoDbContext> DbContextFactory
@inject ISnackbar Snackbar

<PageTitle>Type Marshalling Tests</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Science" Class="mr-2" />
        .NET Type Marshalling Tests
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
        Tests all .NET data types to verify JSON marshalling between C# and JavaScript worker
    </MudText>

    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudStack Spacing="3">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="RunAllTypesTestAsync"
                       StartIcon="@Icons.Material.Filled.PlayArrow"
                       Disabled="_isRunning">
                Run Complete Type Test
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="ClearTypeTestsAsync"
                       StartIcon="@Icons.Material.Filled.Delete">
                Clear Test Data
            </MudButton>

            @if (!string.IsNullOrEmpty(_testResults))
            {
                <MudAlert Severity="@_testSeverity" Variant="Variant.Outlined">
                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace;">@_testResults</MudText>
                </MudAlert>
            }
        </MudStack>
    </MudPaper>

    @if (_testEntries.Any())
    {
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">Test Data (@_testEntries.Count entries)</MudText>
            <MudTable Items="_testEntries" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Int</MudTh>
                    <MudTh>Long</MudTh>
                    <MudTh>Double</MudTh>
                    <MudTh>Decimal</MudTh>
                    <MudTh>Bool</MudTh>
                    <MudTh>DateTime</MudTh>
                    <MudTh>Guid</MudTh>
                    <MudTh>Enum</MudTh>
                    <MudTh>Nullable Int</MudTh>
                    <MudTh>IntList (JSON)</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@context.Id</MudTd>
                    <MudTd DataLabel="Int">@context.IntValue</MudTd>
                    <MudTd DataLabel="Long">@context.LongValue</MudTd>
                    <MudTd DataLabel="Double">@context.DoubleValue.ToString("F2")</MudTd>
                    <MudTd DataLabel="Decimal">@context.DecimalValue.ToString("F2")</MudTd>
                    <MudTd DataLabel="Bool">@context.BoolValue</MudTd>
                    <MudTd DataLabel="DateTime">@context.DateTimeValue.ToString("g")</MudTd>
                    <MudTd DataLabel="Guid">@context.GuidValue.ToString()[..8]...</MudTd>
                    <MudTd DataLabel="Enum">@context.EnumValue</MudTd>
                    <MudTd DataLabel="Nullable Int">@(context.NullableIntValue?.ToString() ?? "NULL")</MudTd>
                    <MudTd DataLabel="IntList (JSON)">[@string.Join(", ", context.IntList)]</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    private bool _isRunning;
    private string _testResults = string.Empty;
    private Severity _testSeverity = Severity.Success;
    private List<TypeTestEntity> _testEntries = new();

    private async Task RunAllTypesTestAsync()
    {
        _isRunning = true;
        _testResults = string.Empty;
        StateHasChanged();

        var stopwatch = Stopwatch.StartNew();
        var results = new List<string>();

        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();

            // Create test entity with all types
            var testEntity = new TypeTestEntity
            {
                // Integer types
                ByteValue = 255,
                NullableByteValue = 128,
                ShortValue = -32768,
                NullableShortValue = null,
                IntValue = int.MaxValue,
                NullableIntValue = -42,
                LongValue = long.MaxValue,
                NullableLongValue = null,

                // Floating point
                FloatValue = 3.14159f,
                NullableFloatValue = -2.71828f,
                DoubleValue = Math.PI,
                NullableDoubleValue = null,
                DecimalValue = 123456.789m,
                NullableDecimalValue = -999.99m,

                // Boolean
                BoolValue = true,
                NullableBoolValue = null,

                // String
                StringValue = "Test String with √©mojis üöÄ",
                NullableStringValue = null,

                // DateTime
                DateTimeValue = DateTime.UtcNow,
                NullableDateTimeValue = DateTime.UtcNow.AddDays(-7),
                DateTimeOffsetValue = DateTimeOffset.UtcNow,
                NullableDateTimeOffsetValue = null,
                TimeSpanValue = TimeSpan.FromHours(42),
                NullableTimeSpanValue = TimeSpan.FromMinutes(15),

                // Guid
                GuidValue = Guid.NewGuid(),
                NullableGuidValue = null,

                // Binary
                BlobValue = new byte[] { 0x00, 0x01, 0x02, 0xFF, 0xFE, 0xFD },

                // Enum
                EnumValue = TestEnum.SECOND,
                NullableEnumValue = TestEnum.THIRD,

                // Char
                CharValue = 'A',
                NullableCharValue = null,

                // Collection (JSON)
                IntList = new List<int> { 1, 2, 3, 42, 100 }
            };

            results.Add("‚úì Created test entity with all types");

            // Insert
            context.TypeTests.Add(testEntity);
            await context.SaveChangesAsync();
            results.Add($"‚úì Inserted entity (ID: {testEntity.Id})");

            // Read back
            var retrieved = await context.TypeTests.FindAsync(testEntity.Id);
            if (retrieved is null)
            {
                throw new InvalidOperationException("Failed to retrieve entity");
            }
            results.Add("‚úì Retrieved entity");

            // Verify all types
            var verifications = new List<(string Name, bool Pass)>
            {
                ("ByteValue", retrieved.ByteValue == testEntity.ByteValue),
                ("NullableByteValue (null)", retrieved.NullableByteValue == testEntity.NullableByteValue),
                ("ShortValue", retrieved.ShortValue == testEntity.ShortValue),
                ("IntValue", retrieved.IntValue == testEntity.IntValue),
                ("LongValue", retrieved.LongValue == testEntity.LongValue),
                ("FloatValue", Math.Abs(retrieved.FloatValue - testEntity.FloatValue) < 0.0001f),
                ("DoubleValue", Math.Abs(retrieved.DoubleValue - testEntity.DoubleValue) < 0.0001),
                ("DecimalValue", retrieved.DecimalValue == testEntity.DecimalValue),
                ("BoolValue", retrieved.BoolValue == testEntity.BoolValue),
                ("NullableBoolValue (null)", retrieved.NullableBoolValue == testEntity.NullableBoolValue),
                ("StringValue", retrieved.StringValue == testEntity.StringValue),
                ("NullableStringValue (null)", retrieved.NullableStringValue == testEntity.NullableStringValue),
                ("DateTimeValue", (retrieved.DateTimeValue - testEntity.DateTimeValue).TotalSeconds < 1),
                ("GuidValue", retrieved.GuidValue == testEntity.GuidValue),
                ("NullableGuidValue (null)", retrieved.NullableGuidValue == testEntity.NullableGuidValue),
                ("BlobValue", retrieved.BlobValue != null && retrieved.BlobValue.SequenceEqual(testEntity.BlobValue)),
                ("EnumValue", retrieved.EnumValue == testEntity.EnumValue),
                ("NullableEnumValue", retrieved.NullableEnumValue == testEntity.NullableEnumValue),
                ("CharValue", retrieved.CharValue == testEntity.CharValue),
                ("NullableCharValue (null)", retrieved.NullableCharValue == testEntity.NullableCharValue),
                ("IntList (JSON collection)", retrieved.IntList.SequenceEqual(testEntity.IntList))
            };

            var failedVerifications = verifications.Where(v => !v.Pass).ToList();
            if (failedVerifications.Any())
            {
                results.Add("‚ùå FAILED VERIFICATIONS:");
                foreach (var (name, _) in failedVerifications)
                {
                    results.Add($"  - {name}");
                }
                _testSeverity = Severity.Error;
            }
            else
            {
                results.Add($"‚úì All {verifications.Count} type verifications passed!");
                _testSeverity = Severity.Success;
            }

            // Load all test entries for display
            _testEntries = await context.TypeTests.ToListAsync();

            stopwatch.Stop();
            results.Add($"\n‚è± Completed in {stopwatch.ElapsedMilliseconds}ms");

            _testResults = string.Join("\n", results);
            Snackbar.Add($"Type test completed in {stopwatch.ElapsedMilliseconds}ms",
                _testSeverity == Severity.Success ? Severity.Success : Severity.Error);
        }
        catch (Exception ex)
        {
            _testSeverity = Severity.Error;
            _testResults = $"‚ùå TEST FAILED:\n{ex.Message}\n\nStack Trace:\n{ex.StackTrace}";
            Snackbar.Add($"Test failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRunning = false;
            StateHasChanged();
        }
    }

    private async Task ClearTypeTestsAsync()
    {
        try
        {
            // Delete and recreate database to handle schema changes
            await SqliteWasmWorkerBridge.Instance.DeleteDatabaseAsync("TodoDb.db");

            // Recreate database schema
            await using var context = await DbContextFactory.CreateDbContextAsync();
            await context.Database.EnsureCreatedAsync();

            _testEntries.Clear();
            _testResults = "‚úì Database rebuilt with new schema";
            _testSeverity = Severity.Info;
            Snackbar.Add("Database rebuilt successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            _testResults = $"‚ùå Clear failed: {ex.Message}";
            _testSeverity = Severity.Error;
            Snackbar.Add($"Clear failed: {ex.Message}", Severity.Error);
        }
    }
}
