@page "/todos"
@using Microsoft.EntityFrameworkCore
@using System.Diagnostics
@using SqliteWasmBlazor.Models
@using SqliteWasmBlazor.Models.Models
@using SqliteWasmBlazor.Models.Extensions
@inject IDbContextFactory<TodoDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject IDBInitializationService DBInitializationService
@implements IDisposable

<PageTitle>Todo List</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Storage" Class="mr-2" />
        SqliteWasmBlazor Todo List
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
        Persistent storage using SQLite WASM with OPFS - Data survives page refresh!
    </MudText>

    <DatabaseErrorAlert />

    @if (DBInitializationService.ErrorMessage is not null)
    {
        return;
    }

    <!-- Add New Todo Card -->
    <MudPaper Elevation="2" Class="pa-4 mb-6">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" Class="mr-1" />
            Add New Todo
        </MudText>
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_newTitle"
                              Label="Title"
                              Variant="Variant.Outlined"
                              Required="true"
                              Immediate="true"
                              OnKeyDown="HandleKeyDownAsync" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_newDescription"
                              Label="Description"
                              Variant="Variant.Outlined"
                              OnKeyDown="HandleKeyDownAsync" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="AddTodoAsync"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Add"
                           Size="Size.Large">
                    Add
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Search Card -->
    <MudPaper Elevation="2" Class="pa-4 mb-6">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Search" Size="Size.Small" Class="mr-1" />
            Search
            <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">FTS5 Enabled</MudChip>
        </MudText>
        <TodoSearchComponent SearchString="@_searchString"
                            SearchStringChanged="@OnSearchStringChanged"
                            SearchMode="@_searchMode"
                            SearchModeChanged="@OnSearchModeChanged"
                            QueryMode="@_fts5QueryMode"
                            QueryModeChanged="@OnQueryModeChanged" />
    </MudPaper>

    <!-- Todo List Table -->
    <MudPaper Elevation="2" Class="pa-4 mb-6">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Small" Class="mr-1" />
            Todo Items (@_totalCount)
            @if (!string.IsNullOrWhiteSpace(_searchString))
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Primary" OnClose="ClearSearchAsync">
                    Filtered: @_searchString
                </MudChip>
            }
        </MudText>

        <MudTable ServerData="LoadServerDataAsync"
                  Hover="true"
                  Breakpoint="Breakpoint.Sm"
                  Dense="true"
                  @ref="Table">
            <HeaderContent>
                <MudTh>Status</MudTh>
                <MudTh>Title</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Created</MudTh>
                <MudTh Style="text-align: right;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Status">
                    <MudCheckBox T="bool"
                                 Value="@context.IsCompleted"
                                 ValueChanged="async (_) => await ToggleCompleteAsync(context)"
                                 Color="Color.Success" />
                </MudTd>
                <MudTd DataLabel="Title">
                    <HighlightedText PlainContent="@context.Title"
                                     HighlightedContent="@GetHighlightedText(context.Id, isTitle: true)"
                                     UseHighlighting="@(_searchMode != TodoSearchComponent.SearchDisplayMode.Normal)"
                                     Strikethrough="@context.IsCompleted" />
                </MudTd>
                <MudTd DataLabel="Description">
                    <HighlightedText PlainContent="@context.Description"
                                     HighlightedContent="@GetHighlightedText(context.Id, isTitle: false)"
                                     UseHighlighting="@(_searchMode != TodoSearchComponent.SearchDisplayMode.Normal)"
                                     Strikethrough="@context.IsCompleted" />
                </MudTd>
                <MudTd DataLabel="Created">
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text">
                        @context.CreatedAt.ToString("g")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Actions" Style="text-align: right;">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="async () => await DeleteTodoAsync(context)" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No todos yet. Add one above to get started!</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="[10, 25, 50, 100]" />
            </PagerContent>
        </MudTable>
    </MudPaper>

    <!-- Database Info Card -->
    <MudPaper Elevation="2" Class="pa-4">
        <MudGrid>
            <MudItem xs="12" sm="8">
                <MudText Typo="Typo.h6" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                    Database Information
                </MudText>
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Size="Size.Small" />
                        <MudText Typo="Typo.body2">
                            <strong>Total Items:</strong> @_totalCount
                        </MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.DataUsage" Size="Size.Small" />
                        <MudText Typo="Typo.body2">
                            <strong>Database Size:</strong> @FormatBytes(_databaseFileSize)
                        </MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" />
                        <MudText Typo="Typo.body2">
                            <strong>Storage:</strong> OPFS (Origin Private File System)
                        </MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                        <MudText Typo="Typo.body2">
                            <strong>Persistence:</strong> Data survives page refresh!
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudItem>
            <MudItem xs="12" sm="4" Style="display: flex; align-items: center; justify-content: center;">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           OnClick="RefreshListAsync"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           Size="Size.Large">
                    Refresh List
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    public required MudTable<TodoItem> Table;
    private int _totalCount;
    private long _databaseFileSize;
    private string _newTitle = string.Empty;
    private string _newDescription = string.Empty;
    private string _searchString = string.Empty;
    private TodoSearchComponent.SearchDisplayMode _searchMode = TodoSearchComponent.SearchDisplayMode.Normal;
    private Fts5QueryMode _fts5QueryMode = Fts5QueryMode.Processed;
    private CancellationTokenSource? _searchCts;
    private Timer? _debounceTimer;
    private Dictionary<int, (string Title, string Description)> _highlightCache = new();

    protected override async Task OnInitializedAsync()
    {
        await UpdateTotalCountAsync();
        await UpdateDatabaseFileSizeAsync();
    }

    private async Task<TableData<TodoItem>> LoadServerDataAsync(TableState state, CancellationToken cancellationToken)
    {
        await using var context = await DbContextFactory.CreateDbContextAsync(cancellationToken);

        _highlightCache.Clear(); // Clear cache for new results

        // Use FTS5 search if search string is provided
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            try
            {
                if (_searchMode == TodoSearchComponent.SearchDisplayMode.Highlight)
                {
                // Use FTS5 with highlighting
                var query = context.SearchTodoItemsWithHighlight(_searchString, "<mark>", "</mark>", _fts5QueryMode);
                var count = await query.CountAsync(cancellationToken);
                _totalCount = count;

                var highlightedResults = await query
                    .Skip(state.Page * state.PageSize)
                    .Take(state.PageSize)
                    .ToListAsync(cancellationToken);

                // Cache highlighted text (now accessing properties directly due to inheritance)
                foreach (var result in highlightedResults)
                {
                    _highlightCache[result.Id] = (result.DisplayTitle, result.DisplayDescription);
                }

                return new TableData<TodoItem>
                {
                    // Can cast because TodoItemSearchResult inherits from TodoItem
                    Items = highlightedResults.Cast<TodoItem>().ToList(),
                    TotalItems = count
                };
            }
            else if (_searchMode == TodoSearchComponent.SearchDisplayMode.Snippet)
            {
                // Use FTS5 with snippets (5 tokens = ~5-7 words for short excerpts)
                var query = context.SearchTodoItemsWithSnippet(_searchString, "<mark>", "</mark>", "...", 5, _fts5QueryMode);
                var count = await query.CountAsync(cancellationToken);
                _totalCount = count;

                var snippetResults = await query
                    .Skip(state.Page * state.PageSize)
                    .Take(state.PageSize)
                    .ToListAsync(cancellationToken);

                // Cache snippet text (now accessing properties directly due to inheritance)
                foreach (var result in snippetResults)
                {
                    _highlightCache[result.Id] = (result.DisplayTitleSnippet, result.DisplayDescriptionSnippet);
                }

                return new TableData<TodoItem>
                {
                    // Can cast because TodoItemSnippetResult inherits from TodoItem
                    Items = snippetResults.Cast<TodoItem>().ToList(),
                    TotalItems = count
                };
            }
            else
            {
                // Use FTS5 without highlighting or snippets
                var query = context.SearchTodoItems(_searchString, _fts5QueryMode);
                var count = await query.CountAsync(cancellationToken);
                _totalCount = count;

                var data = await query
                    .Skip(state.Page * state.PageSize)
                    .Take(state.PageSize)
                    .ToListAsync(cancellationToken);

                return new TableData<TodoItem>
                {
                    Items = data,
                    TotalItems = count
                };
            }
            }
            catch (Exception ex) when (ex is not OperationCanceledException and not TaskCanceledException)
            {
                // Handle FTS5 syntax errors (but ignore cancellation from debouncing)
                var errorMessage = ex.Message.Contains("fts5: syntax error")
                    ? $"FTS5 Syntax Error: {ExtractFts5Error(ex.Message)}"
                    : $"Search Error: {ex.Message}";

                Snackbar.Add(errorMessage, Severity.Error);

                // Return empty result on error
                _totalCount = 0;
                return new TableData<TodoItem>
                {
                    Items = new List<TodoItem>(),
                    TotalItems = 0
                };
            }
        }
        else
        {
            // Regular query when no search
            var query = context.TodoItems.OrderByDescending(t => t.CreatedAt);
            var count = await query.CountAsync(cancellationToken);
            _totalCount = count;

            var data = await query
                .Skip(state.Page * state.PageSize)
                .Take(state.PageSize)
                .ToListAsync(cancellationToken);

            return new TableData<TodoItem>
            {
                Items = data,
                TotalItems = count
            };
        }
    }

    private string? GetHighlightedText(int itemId, bool isTitle)
    {
        // Return highlighted text from FTS5 cache if available (already contains <mark> tags)
        if (_highlightCache.TryGetValue(itemId, out var highlighted))
        {
            return isTitle ? highlighted.Title : highlighted.Description;
        }

        return null;
    }

    private async Task UpdateTotalCountAsync()
    {
        await using var context = await DbContextFactory.CreateDbContextAsync();

        IQueryable<TodoItem> query;

        // Use FTS5 search if search string is provided
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            query = context.SearchTodoItems(_searchString, _fts5QueryMode);
        }
        else
        {
            query = context.TodoItems;
        }

        _totalCount = await query.CountAsync();
        StateHasChanged();
    }

    private async Task UpdateDatabaseFileSizeAsync()
    {
        try
        {
            await using var context = await DbContextFactory.CreateDbContextAsync();
            var fileSize = await context.Database.SqlQueryRaw<long>(
                "SELECT (SELECT page_count FROM pragma_page_count()) * (SELECT page_size FROM pragma_page_size()) AS Value"
            ).SingleOrDefaultAsync();
            _databaseFileSize = fileSize;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to get database file size: {ex.Message}");
            _databaseFileSize = 0;
        }
    }

    private static string FormatBytes(long bytes)
    {
        if (bytes < 1024)
        {
            return $"{bytes} B";
        }
        if (bytes < 1024 * 1024)
        {
            return $"{bytes / 1024.0:F2} KB";
        }
        if (bytes < 1024 * 1024 * 1024)
        {
            return $"{bytes / (1024.0 * 1024.0):F2} MB";
        }
        return $"{bytes / (1024.0 * 1024.0 * 1024.0):F2} GB";
    }

    private async Task AddTodoAsync()
    {
        if (string.IsNullOrWhiteSpace(_newTitle))
        {
            Snackbar.Add("Please enter a title", Severity.Warning);
            return;
        }

        var stopwatch = Stopwatch.StartNew();

        var todo = new TodoItem
        {
            Title = _newTitle,
            Description = _newDescription,
            CreatedAt = DateTime.UtcNow,
            IsCompleted = false
        };

        await using var context = await DbContextFactory.CreateDbContextAsync();
        context.TodoItems.Add(todo);
        await context.SaveChangesAsync();

        stopwatch.Stop();

        _newTitle = string.Empty;
        _newDescription = string.Empty;

        await Table.ReloadServerData();
        await UpdateDatabaseFileSizeAsync();
        Snackbar.Add($"Todo created in {stopwatch.ElapsedMilliseconds}ms", Severity.Success);
    }

    private async Task ToggleCompleteAsync(TodoItem todo)
    {
        var stopwatch = Stopwatch.StartNew();

        todo.IsCompleted = !todo.IsCompleted;
        todo.CompletedAt = todo.IsCompleted ? DateTime.UtcNow : null;

        await using var context = await DbContextFactory.CreateDbContextAsync();
        context.TodoItems.Update(todo);
        await context.SaveChangesAsync();

        stopwatch.Stop();

        await Table.ReloadServerData();
        var action = todo.IsCompleted ? "completed" : "reopened";
        Snackbar.Add($"Todo {action} in {stopwatch.ElapsedMilliseconds}ms", Severity.Info);
    }

    private async Task DeleteTodoAsync(TodoItem todo)
    {
        var stopwatch = Stopwatch.StartNew();

        await using var context = await DbContextFactory.CreateDbContextAsync();
        context.TodoItems.Remove(todo);

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            // Item was already deleted (e.g., by another tab or concurrent operation)
            // This is fine - just show a warning and refresh the list
            Snackbar.Add("Item was already deleted", Severity.Warning);
            await Table.ReloadServerData();
            return;
        }

        stopwatch.Stop();

        await Table.ReloadServerData();
        await UpdateDatabaseFileSizeAsync();
        Snackbar.Add($"Todo deleted in {stopwatch.ElapsedMilliseconds}ms", Severity.Error);
    }

    private async Task RefreshListAsync()
    {
        var stopwatch = Stopwatch.StartNew();

        await Table.ReloadServerData();
        await UpdateDatabaseFileSizeAsync();

        stopwatch.Stop();

        Snackbar.Add($"List refreshed in {stopwatch.ElapsedMilliseconds}ms", Severity.Info);
    }

    private async Task HandleKeyDownAsync(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTodoAsync();
        }
    }

    private void OnSearchStringChanged(string text)
    {
        _searchString = text;

        // Cancel any pending search
        _searchCts?.Cancel();
        _searchCts?.Dispose();
        _searchCts = new CancellationTokenSource();

        // Debounce: wait 300ms before executing search
        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(_ =>
        {
            _ = InvokeAsync(async () =>
            {
                try
                {
                    if (_searchCts is { IsCancellationRequested: false })
                    {
                        await Table.ReloadServerData();
                        StateHasChanged();
                    }
                }
                catch (OperationCanceledException)
                {
                    // Ignore cancellation
                }
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task OnSearchModeChanged(TodoSearchComponent.SearchDisplayMode mode)
    {
        _searchMode = mode;

        // Only reload if there's an active search
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            await Table.ReloadServerData();
            StateHasChanged();
        }
    }

    private async Task OnQueryModeChanged(Fts5QueryMode mode)
    {
        _fts5QueryMode = mode;

        // Only reload if there's an active search
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            await Table.ReloadServerData();
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _searchCts?.Cancel();
        _searchCts?.Dispose();
        _debounceTimer?.Dispose();
    }

    private async Task ClearSearchAsync()
    {
        _searchString = string.Empty;
        await Table.ReloadServerData();
        StateHasChanged();
    }

    private static string ExtractFts5Error(string fullErrorMessage)
    {
        // Extract the meaningful part of the FTS5 error message
        // Example: "fts5: syntax error near 'OR'" â†’ "syntax error near 'OR'"
        var fts5Index = fullErrorMessage.IndexOf("fts5:", StringComparison.OrdinalIgnoreCase);
        if (fts5Index >= 0)
        {
            var errorStart = fts5Index + 5; // Skip "fts5:"
            var errorPart = fullErrorMessage[errorStart..].Trim();

            // Add helpful hint based on common errors
            if (errorPart.Contains("syntax error near"))
            {
                if (fullErrorMessage.Contains("NEAR"))
                {
                    return $"{errorPart}. Tip: NEAR syntax is 'NEAR(term1 term2, distance)' - space-separated terms, comma before distance.";
                }
                return $"{errorPart}. Tip: Column filters use 'title:term' not '#column'. NEAR uses 'NEAR(term1 term2, distance)'.";
            }

            return errorPart;
        }

        return fullErrorMessage;
    }
}
