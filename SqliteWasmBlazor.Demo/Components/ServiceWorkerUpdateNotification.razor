@inject ISnackbar Snackbar
@inject IJSRuntime JS
@implements IAsyncDisposable

@code {
    private DotNetObjectReference<ServiceWorkerUpdateNotification>? _objRef;
    private Snackbar? _updateSnackbar;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _objRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("ServiceWorkerUpdate.registerUpdateCallback", _objRef);
            }
            catch (JSException)
            {
                // ServiceWorkerUpdate not available (e.g., in debug mode where service worker is disabled)
                // This is expected and can be safely ignored
            }
        }
    }

    [JSInvokable]
    public void OnUpdateAvailable()
    {
        _updateSnackbar = Snackbar.Add(
            @<MudPaper Class="pa-6">
                <MudStack Spacing="2" StretchItems="StretchItems.All">
                    <MudText Typo="Typo.body1" Align="Align.Center">An update for this application is available!</MudText>
                    <MudText Typo="Typo.body2" Style="font-weight:bold" Color="Color.Warning" Align="Align.Center">
                        Demo Notice
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Warning" Align="Align.Center">
                        If you encounter any issues after updating, please use "Reset Database" from the TodoList page.
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UpdateApp">Update</MudButton>
                </MudStack>
            </MudPaper>,
            Severity.Info,
            config =>
            {
                config.RequireInteraction = true;
                config.DuplicatesBehavior = SnackbarDuplicatesBehavior.Prevent;
            });
    }

    private async Task UpdateApp()
    {
        if (_updateSnackbar is not null)
        {
            Snackbar.Remove(_updateSnackbar);
            _updateSnackbar = null;
        }

        await JS.InvokeVoidAsync("ServiceWorkerUpdate.skipWaitingAndReload");
    }

    public async ValueTask DisposeAsync()
    {
        if (_objRef is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("ServiceWorkerUpdate.registerUpdateCallback", null);
            }
            catch (JSException)
            {
                // ServiceWorkerUpdate not available - safe to ignore
            }
            _objRef.Dispose();
        }
    }

}
