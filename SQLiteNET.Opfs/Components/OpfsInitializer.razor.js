// opfs-initializer.ts
var worker = null;
var messageId = 0;
var pendingMessages = /* @__PURE__ */ new Map();
var isInitialized = false;
function sendMessage(type, args) {
  if (!worker) {
    return Promise.reject(new Error("Worker not initialized"));
  }
  return new Promise((resolve, reject) => {
    const id = messageId++;
    pendingMessages.set(id, { resolve, reject });
    const message = { id, type, args };
    worker.postMessage(message);
  });
}
async function initialize() {
  if (isInitialized) {
    return {
      success: true,
      message: "Already initialized"
    };
  }
  try {
    console.log("[OPFS Initializer] Creating worker...");
    worker = new Worker(
      "/_content/SQLiteNET.Opfs/opfs-worker.js",
      { type: "module" }
    );
    worker.onmessage = (event) => {
      const { id, success, result, error } = event.data;
      const pending = pendingMessages.get(id);
      if (pending) {
        pendingMessages.delete(id);
        if (success) {
          pending.resolve(result);
        } else {
          pending.reject(new Error(error || "Unknown error"));
        }
      }
    };
    window.addEventListener("beforeunload", () => {
      if (worker) {
        try {
          worker.postMessage({ id: -1, type: "cleanup" });
        } catch (e) {
          console.warn("[OPFS Initializer] Could not send cleanup message:", e);
        }
      }
    });
    await new Promise((resolve, reject) => {
      const timeout = setTimeout(() => reject(new Error("Worker initialization timeout")), 1e4);
      worker.addEventListener("message", function onReady(event) {
        if (event.data.type === "ready") {
          clearTimeout(timeout);
          worker.removeEventListener("message", onReady);
          resolve();
        } else if (event.data.type === "error") {
          clearTimeout(timeout);
          worker.removeEventListener("message", onReady);
          reject(new Error(event.data.error));
        }
      });
    });
    console.log("[OPFS Initializer] Worker ready, getting capacity...");
    const capacityResult = await sendMessage("getCapacity");
    const fileListResult = await sendMessage("getFileList");
    isInitialized = true;
    console.log("[OPFS Initializer] Initialization complete");
    return {
      success: true,
      message: "OPFS Worker initialized successfully",
      capacity: capacityResult.capacity,
      fileCount: fileListResult.files.length
    };
  } catch (error) {
    console.error("[OPFS Initializer] Failed to initialize:", error);
    return {
      success: false,
      message: error instanceof Error ? error.message : "Unknown error"
    };
  }
}
function isReady() {
  return isInitialized;
}
async function getFileList() {
  const result = await sendMessage("getFileList");
  return result.files || [];
}
async function exportDatabase(filename) {
  const result = await sendMessage("readFile", { filename });
  return result.data;
}
async function importDatabase(filename, dataArray) {
  const result = await sendMessage("writeFile", { filename, data: dataArray });
  return result.bytesWritten;
}
async function deleteDatabase(filename) {
  const result = await sendMessage("deleteFile", { filename });
  return result.success;
}
async function getCapacity() {
  const result = await sendMessage("getCapacity");
  return result.capacity;
}
async function addCapacity(count) {
  const result = await sendMessage("addCapacity", { count });
  return result.newCapacity;
}
async function persist(filename) {
  console.log("[OPFS Persist] Starting persist for:", filename);
  if (!window.Blazor?.runtime?.Module?.FS) {
    throw new Error("Emscripten FS not available. Ensure WasmBuildNative=true is enabled.");
  }
  const fs = window.Blazor.runtime.Module.FS;
  const filePath = `/${filename}`;
  const pathInfo = fs.analyzePath(filePath);
  console.log("[OPFS Persist] File exists in MEMFS:", pathInfo.exists);
  if (!pathInfo.exists) {
    throw new Error(`Database file ${filename} not found in MEMFS`);
  }
  const data = fs.readFile(filePath);
  console.log("[OPFS Persist] Read from MEMFS:", data.length, "bytes");
  await sendMessage("writeFile", {
    filename,
    data: Array.from(data)
  });
  console.log("[OPFS Persist] Written to OPFS:", filename);
}
async function persistDirtyPages(filename, pages) {
  console.log("[OPFS Persist Dirty] Starting incremental persist for:", filename, "-", pages.length, "pages");
  const result = await sendMessage("persistDirtyPages", {
    filename,
    pages
  });
  console.log("[OPFS Persist Dirty] Written", result.pagesWritten, "pages (", result.bytesWritten, "bytes)");
}
async function load(filename) {
  console.log("[OPFS Load] Starting load for:", filename);
  if (!window.Blazor?.runtime?.Module?.FS) {
    throw new Error("Emscripten FS not available. Ensure WasmBuildNative=true is enabled.");
  }
  const fs = window.Blazor.runtime.Module.FS;
  const filePath = `/${filename}`;
  try {
    const result = await sendMessage("readFile", { filename });
    console.log("[OPFS Load] Read from OPFS:", result.data?.length || 0, "bytes");
    if (result.data && result.data.length > 0) {
      fs.writeFile(filePath, new Uint8Array(result.data));
      console.log("[OPFS Load] Written to MEMFS:", filename);
    }
  } catch (error) {
    console.log(`[OPFS Load] Database ${filename} not found in OPFS (will be created on first use)`);
  }
}
async function cleanup() {
  if (worker) {
    console.log("[OPFS Initializer] Requesting cleanup...");
    try {
      await sendMessage("cleanup");
      console.log("[OPFS Initializer] Cleanup complete");
    } catch (e) {
      console.warn("[OPFS Initializer] Cleanup failed:", e);
    }
  }
}
console.log("[OPFS Initializer] Module loaded");
export {
  addCapacity,
  cleanup,
  deleteDatabase,
  exportDatabase,
  getCapacity,
  getFileList,
  importDatabase,
  initialize,
  isReady,
  load,
  persist,
  persistDirtyPages
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vVHlwZXNjcmlwdC9vcGZzLWluaXRpYWxpemVyLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvLyBvcGZzLWluaXRpYWxpemVyLnRzXG4vLyBNYWluIHRocmVhZCB3cmFwcGVyIGZvciBPUEZTIFdvcmtlclxuLy8gSGFuZGxlcyBjb21tdW5pY2F0aW9uIHdpdGggb3Bmcy13b3JrZXIuanMgZm9yIGZpbGUgSS9PXG5cbmludGVyZmFjZSBJbml0aWFsaXplUmVzdWx0IHtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIG1lc3NhZ2U6IHN0cmluZztcbiAgICBjYXBhY2l0eT86IG51bWJlcjtcbiAgICBmaWxlQ291bnQ/OiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBXb3JrZXJNZXNzYWdlIHtcbiAgICBpZDogbnVtYmVyO1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBhcmdzPzogYW55O1xufVxuXG5pbnRlcmZhY2UgV29ya2VyUmVzcG9uc2Uge1xuICAgIGlkOiBudW1iZXI7XG4gICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICByZXN1bHQ/OiBhbnk7XG4gICAgZXJyb3I/OiBzdHJpbmc7XG59XG5cbmxldCB3b3JrZXI6IFdvcmtlciB8IG51bGwgPSBudWxsO1xubGV0IG1lc3NhZ2VJZCA9IDA7XG5sZXQgcGVuZGluZ01lc3NhZ2VzID0gbmV3IE1hcDxudW1iZXIsIHsgcmVzb2x2ZTogRnVuY3Rpb247IHJlamVjdDogRnVuY3Rpb24gfT4oKTtcbmxldCBpc0luaXRpYWxpemVkID0gZmFsc2U7XG5cbmZ1bmN0aW9uIHNlbmRNZXNzYWdlKHR5cGU6IHN0cmluZywgYXJncz86IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgaWYgKCF3b3JrZXIpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignV29ya2VyIG5vdCBpbml0aWFsaXplZCcpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBpZCA9IG1lc3NhZ2VJZCsrO1xuICAgICAgICBwZW5kaW5nTWVzc2FnZXMuc2V0KGlkLCB7IHJlc29sdmUsIHJlamVjdCB9KTtcblxuICAgICAgICBjb25zdCBtZXNzYWdlOiBXb3JrZXJNZXNzYWdlID0geyBpZCwgdHlwZSwgYXJncyB9O1xuICAgICAgICB3b3JrZXIhLnBvc3RNZXNzYWdlKG1lc3NhZ2UpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpOiBQcm9taXNlPEluaXRpYWxpemVSZXN1bHQ+IHtcbiAgICBpZiAoaXNJbml0aWFsaXplZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdBbHJlYWR5IGluaXRpYWxpemVkJ1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBJbml0aWFsaXplcl0gQ3JlYXRpbmcgd29ya2VyLi4uJyk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHdvcmtlciBmcm9tIGJ1bmRsZWQgd29ya2VyIGZpbGVcbiAgICAgICAgd29ya2VyID0gbmV3IFdvcmtlcihcbiAgICAgICAgICAgICcvX2NvbnRlbnQvU1FMaXRlTkVULk9wZnMvb3Bmcy13b3JrZXIuanMnLFxuICAgICAgICAgICAgeyB0eXBlOiAnbW9kdWxlJyB9XG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gU2V0IHVwIG1lc3NhZ2UgaGFuZGxlclxuICAgICAgICB3b3JrZXIub25tZXNzYWdlID0gKGV2ZW50OiBNZXNzYWdlRXZlbnQ8V29ya2VyUmVzcG9uc2U+KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGlkLCBzdWNjZXNzLCByZXN1bHQsIGVycm9yIH0gPSBldmVudC5kYXRhO1xuXG4gICAgICAgICAgICBjb25zdCBwZW5kaW5nID0gcGVuZGluZ01lc3NhZ2VzLmdldChpZCk7XG4gICAgICAgICAgICBpZiAocGVuZGluZykge1xuICAgICAgICAgICAgICAgIHBlbmRpbmdNZXNzYWdlcy5kZWxldGUoaWQpO1xuICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucmVqZWN0KG5ldyBFcnJvcihlcnJvciB8fCAnVW5rbm93biBlcnJvcicpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQ2xlYW4gdXAgaGFuZGxlcyBiZWZvcmUgcGFnZSB1bmxvYWRcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsICgpID0+IHtcbiAgICAgICAgICAgIGlmICh3b3JrZXIpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAvLyBTZW5kIHN5bmNocm9ub3VzIGNsZWFudXAgbWVzc2FnZSAoYmVzdCBlZmZvcnQpXG4gICAgICAgICAgICAgICAgICAgIHdvcmtlci5wb3N0TWVzc2FnZSh7IGlkOiAtMSwgdHlwZTogJ2NsZWFudXAnIH0pO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdbT1BGUyBJbml0aWFsaXplcl0gQ291bGQgbm90IHNlbmQgY2xlYW51cCBtZXNzYWdlOicsIGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gV2FpdCBmb3Igd29ya2VyIHJlYWR5IHNpZ25hbFxuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKCdXb3JrZXIgaW5pdGlhbGl6YXRpb24gdGltZW91dCcpKSwgMTAwMDApO1xuXG4gICAgICAgICAgICB3b3JrZXIhLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBmdW5jdGlvbiBvblJlYWR5KGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEudHlwZSA9PT0gJ3JlYWR5Jykge1xuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIHdvcmtlciEucmVtb3ZlRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uUmVhZHkpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5kYXRhLnR5cGUgPT09ICdlcnJvcicpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICB3b3JrZXIhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBvblJlYWR5KTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihldmVudC5kYXRhLmVycm9yKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBJbml0aWFsaXplcl0gV29ya2VyIHJlYWR5LCBnZXR0aW5nIGNhcGFjaXR5Li4uJyk7XG5cbiAgICAgICAgLy8gR2V0IGluaXRpYWwgY2FwYWNpdHkgYW5kIGZpbGUgY291bnRcbiAgICAgICAgY29uc3QgY2FwYWNpdHlSZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZ2V0Q2FwYWNpdHknKTtcbiAgICAgICAgY29uc3QgZmlsZUxpc3RSZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZ2V0RmlsZUxpc3QnKTtcblxuICAgICAgICBpc0luaXRpYWxpemVkID0gdHJ1ZTtcblxuICAgICAgICBjb25zb2xlLmxvZygnW09QRlMgSW5pdGlhbGl6ZXJdIEluaXRpYWxpemF0aW9uIGNvbXBsZXRlJyk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBtZXNzYWdlOiAnT1BGUyBXb3JrZXIgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgICAgIGNhcGFjaXR5OiBjYXBhY2l0eVJlc3VsdC5jYXBhY2l0eSxcbiAgICAgICAgICAgIGZpbGVDb3VudDogZmlsZUxpc3RSZXN1bHQuZmlsZXMubGVuZ3RoXG4gICAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignW09QRlMgSW5pdGlhbGl6ZXJdIEZhaWxlZCB0byBpbml0aWFsaXplOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcidcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1JlYWR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBpc0luaXRpYWxpemVkO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZUxpc3QoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbmRNZXNzYWdlKCdnZXRGaWxlTGlzdCcpO1xuICAgIHJldHVybiByZXN1bHQuZmlsZXMgfHwgW107XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleHBvcnREYXRhYmFzZShmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXJbXT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbmRNZXNzYWdlKCdyZWFkRmlsZScsIHsgZmlsZW5hbWUgfSk7XG4gICAgcmV0dXJuIHJlc3VsdC5kYXRhO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW1wb3J0RGF0YWJhc2UoZmlsZW5hbWU6IHN0cmluZywgZGF0YUFycmF5OiBudW1iZXJbXSk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VuZE1lc3NhZ2UoJ3dyaXRlRmlsZScsIHsgZmlsZW5hbWUsIGRhdGE6IGRhdGFBcnJheSB9KTtcbiAgICByZXR1cm4gcmVzdWx0LmJ5dGVzV3JpdHRlbjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZURhdGFiYXNlKGZpbGVuYW1lOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZGVsZXRlRmlsZScsIHsgZmlsZW5hbWUgfSk7XG4gICAgcmV0dXJuIHJlc3VsdC5zdWNjZXNzO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q2FwYWNpdHkoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZ2V0Q2FwYWNpdHknKTtcbiAgICByZXR1cm4gcmVzdWx0LmNhcGFjaXR5O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWRkQ2FwYWNpdHkoY291bnQ6IG51bWJlcik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VuZE1lc3NhZ2UoJ2FkZENhcGFjaXR5JywgeyBjb3VudCB9KTtcbiAgICByZXR1cm4gcmVzdWx0Lm5ld0NhcGFjaXR5O1xufVxuXG4vKipcbiAqIFBlcnNpc3QgYSBkYXRhYmFzZSBmaWxlIGZyb20gRW1zY3JpcHRlbiBNRU1GUyB0byBPUEZTLlxuICogUmVhZHMgdGhlIGZpbGUgZnJvbSBuYXRpdmUgV0FTTSBtZW1vcnkgYW5kIHN0b3JlcyBpdCBpbiBPUEZTLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGVyc2lzdChmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc29sZS5sb2coJ1tPUEZTIFBlcnNpc3RdIFN0YXJ0aW5nIHBlcnNpc3QgZm9yOicsIGZpbGVuYW1lKTtcblxuICAgIC8vIENoZWNrIGlmIGZpbGUgZXhpc3RzIGluIEVtc2NyaXB0ZW4gTUVNRlNcbiAgICBpZiAoISh3aW5kb3cgYXMgYW55KS5CbGF6b3I/LnJ1bnRpbWU/Lk1vZHVsZT8uRlMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXNjcmlwdGVuIEZTIG5vdCBhdmFpbGFibGUuIEVuc3VyZSBXYXNtQnVpbGROYXRpdmU9dHJ1ZSBpcyBlbmFibGVkLicpO1xuICAgIH1cblxuICAgIGNvbnN0IGZzID0gKHdpbmRvdyBhcyBhbnkpLkJsYXpvci5ydW50aW1lLk1vZHVsZS5GUztcbiAgICBjb25zdCBmaWxlUGF0aCA9IGAvJHtmaWxlbmFtZX1gO1xuXG4gICAgY29uc3QgcGF0aEluZm8gPSBmcy5hbmFseXplUGF0aChmaWxlUGF0aCk7XG4gICAgY29uc29sZS5sb2coJ1tPUEZTIFBlcnNpc3RdIEZpbGUgZXhpc3RzIGluIE1FTUZTOicsIHBhdGhJbmZvLmV4aXN0cyk7XG5cbiAgICBpZiAoIXBhdGhJbmZvLmV4aXN0cykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGFiYXNlIGZpbGUgJHtmaWxlbmFtZX0gbm90IGZvdW5kIGluIE1FTUZTYCk7XG4gICAgfVxuXG4gICAgLy8gUmVhZCBmcm9tIE1FTUZTXG4gICAgY29uc3QgZGF0YSA9IGZzLnJlYWRGaWxlKGZpbGVQYXRoKTtcbiAgICBjb25zb2xlLmxvZygnW09QRlMgUGVyc2lzdF0gUmVhZCBmcm9tIE1FTUZTOicsIGRhdGEubGVuZ3RoLCAnYnl0ZXMnKTtcblxuICAgIC8vIFdyaXRlIHRvIE9QRlMgdmlhIHdvcmtlclxuICAgIGF3YWl0IHNlbmRNZXNzYWdlKCd3cml0ZUZpbGUnLCB7XG4gICAgICAgIGZpbGVuYW1lLFxuICAgICAgICBkYXRhOiBBcnJheS5mcm9tKGRhdGEpXG4gICAgfSk7XG5cbiAgICBjb25zb2xlLmxvZygnW09QRlMgUGVyc2lzdF0gV3JpdHRlbiB0byBPUEZTOicsIGZpbGVuYW1lKTtcbn1cblxuLyoqXG4gKiBQZXJzaXN0IG9ubHkgZGlydHkgcGFnZXMgZnJvbSBNRU1GUyB0byBPUEZTIChpbmNyZW1lbnRhbCBzeW5jKS5cbiAqIFVzZWQgYnkgVkZTIHRyYWNraW5nIGZvciBlZmZpY2llbnQgcGFydGlhbCB1cGRhdGVzLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGVyc2lzdERpcnR5UGFnZXMoZmlsZW5hbWU6IHN0cmluZywgcGFnZXM6IGFueVtdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc29sZS5sb2coJ1tPUEZTIFBlcnNpc3QgRGlydHldIFN0YXJ0aW5nIGluY3JlbWVudGFsIHBlcnNpc3QgZm9yOicsIGZpbGVuYW1lLCAnLScsIHBhZ2VzLmxlbmd0aCwgJ3BhZ2VzJyk7XG5cbiAgICAvLyBTZW5kIGRpcnR5IHBhZ2VzIHRvIHdvcmtlciBmb3IgcGFydGlhbCB3cml0ZVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbmRNZXNzYWdlKCdwZXJzaXN0RGlydHlQYWdlcycsIHtcbiAgICAgICAgZmlsZW5hbWUsXG4gICAgICAgIHBhZ2VzXG4gICAgfSk7XG5cbiAgICBjb25zb2xlLmxvZygnW09QRlMgUGVyc2lzdCBEaXJ0eV0gV3JpdHRlbicsIHJlc3VsdC5wYWdlc1dyaXR0ZW4sICdwYWdlcyAoJywgcmVzdWx0LmJ5dGVzV3JpdHRlbiwgJ2J5dGVzKScpO1xufVxuXG4vKipcbiAqIExvYWQgYSBkYXRhYmFzZSBmaWxlIGZyb20gT1BGUyB0byBFbXNjcmlwdGVuIE1FTUZTLlxuICogUmVhZHMgdGhlIGZpbGUgZnJvbSBPUEZTIGFuZCB3cml0ZXMgaXQgdG8gbmF0aXZlIFdBU00gbWVtb3J5LlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZChmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc29sZS5sb2coJ1tPUEZTIExvYWRdIFN0YXJ0aW5nIGxvYWQgZm9yOicsIGZpbGVuYW1lKTtcblxuICAgIGlmICghKHdpbmRvdyBhcyBhbnkpLkJsYXpvcj8ucnVudGltZT8uTW9kdWxlPy5GUykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vtc2NyaXB0ZW4gRlMgbm90IGF2YWlsYWJsZS4gRW5zdXJlIFdhc21CdWlsZE5hdGl2ZT10cnVlIGlzIGVuYWJsZWQuJyk7XG4gICAgfVxuXG4gICAgY29uc3QgZnMgPSAod2luZG93IGFzIGFueSkuQmxhem9yLnJ1bnRpbWUuTW9kdWxlLkZTO1xuICAgIGNvbnN0IGZpbGVQYXRoID0gYC8ke2ZpbGVuYW1lfWA7XG5cbiAgICB0cnkge1xuICAgICAgICAvLyBSZWFkIGZyb20gT1BGUyB2aWEgd29ya2VyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbmRNZXNzYWdlKCdyZWFkRmlsZScsIHsgZmlsZW5hbWUgfSk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBMb2FkXSBSZWFkIGZyb20gT1BGUzonLCByZXN1bHQuZGF0YT8ubGVuZ3RoIHx8IDAsICdieXRlcycpO1xuXG4gICAgICAgIGlmIChyZXN1bHQuZGF0YSAmJiByZXN1bHQuZGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAvLyBXcml0ZSB0byBNRU1GU1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlKGZpbGVQYXRoLCBuZXcgVWludDhBcnJheShyZXN1bHQuZGF0YSkpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tPUEZTIExvYWRdIFdyaXR0ZW4gdG8gTUVNRlM6JywgZmlsZW5hbWUpO1xuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gRGF0YWJhc2UgZG9lc24ndCBleGlzdCBpbiBPUEZTIHlldCAtIHRoaXMgaXMgb2theSAod2lsbCBiZSBjcmVhdGVkKVxuICAgICAgICBjb25zb2xlLmxvZyhgW09QRlMgTG9hZF0gRGF0YWJhc2UgJHtmaWxlbmFtZX0gbm90IGZvdW5kIGluIE9QRlMgKHdpbGwgYmUgY3JlYXRlZCBvbiBmaXJzdCB1c2UpYCk7XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xlYW51cCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAod29ya2VyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBJbml0aWFsaXplcl0gUmVxdWVzdGluZyBjbGVhbnVwLi4uJyk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBzZW5kTWVzc2FnZSgnY2xlYW51cCcpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1tPUEZTIEluaXRpYWxpemVyXSBDbGVhbnVwIGNvbXBsZXRlJyk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignW09QRlMgSW5pdGlhbGl6ZXJdIENsZWFudXAgZmFpbGVkOicsIGUpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5jb25zb2xlLmxvZygnW09QRlMgSW5pdGlhbGl6ZXJdIE1vZHVsZSBsb2FkZWQnKTtcbiJdLAogICJtYXBwaW5ncyI6ICI7QUF3QkEsSUFBSSxTQUF3QjtBQUM1QixJQUFJLFlBQVk7QUFDaEIsSUFBSSxrQkFBa0Isb0JBQUksSUFBcUQ7QUFDL0UsSUFBSSxnQkFBZ0I7QUFFcEIsU0FBUyxZQUFZLE1BQWMsTUFBMEI7QUFDekQsTUFBSSxDQUFDLFFBQVE7QUFDVCxXQUFPLFFBQVEsT0FBTyxJQUFJLE1BQU0sd0JBQXdCLENBQUM7QUFBQSxFQUM3RDtBQUVBLFNBQU8sSUFBSSxRQUFRLENBQUMsU0FBUyxXQUFXO0FBQ3BDLFVBQU0sS0FBSztBQUNYLG9CQUFnQixJQUFJLElBQUksRUFBRSxTQUFTLE9BQU8sQ0FBQztBQUUzQyxVQUFNLFVBQXlCLEVBQUUsSUFBSSxNQUFNLEtBQUs7QUFDaEQsV0FBUSxZQUFZ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
