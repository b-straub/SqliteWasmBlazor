// opfs-initializer.ts
var worker = null;
var messageId = 0;
var pendingMessages = /* @__PURE__ */ new Map();
var isInitialized = false;
function sendMessage(type, args) {
  if (!worker) {
    return Promise.reject(new Error("Worker not initialized"));
  }
  return new Promise((resolve, reject) => {
    const id = messageId++;
    pendingMessages.set(id, { resolve, reject });
    const message = { id, type, args };
    worker.postMessage(message);
  });
}
async function initialize() {
  if (isInitialized) {
    return {
      success: true,
      message: "Already initialized"
    };
  }
  try {
    console.log("[OPFS Initializer] Creating worker...");
    worker = new Worker(
      "/_content/SQLiteNET.Opfs/opfs-worker.js",
      { type: "module" }
    );
    worker.onmessage = (event) => {
      const { id, success, result, error } = event.data;
      const pending = pendingMessages.get(id);
      if (pending) {
        pendingMessages.delete(id);
        if (success) {
          pending.resolve(result);
        } else {
          pending.reject(new Error(error || "Unknown error"));
        }
      }
    };
    window.addEventListener("beforeunload", () => {
      if (worker) {
        try {
          worker.postMessage({ id: -1, type: "cleanup" });
        } catch (e) {
          console.warn("[OPFS Initializer] Could not send cleanup message:", e);
        }
      }
    });
    await new Promise((resolve, reject) => {
      const timeout = setTimeout(() => reject(new Error("Worker initialization timeout")), 1e4);
      worker.addEventListener("message", function onReady(event) {
        if (event.data.type === "ready") {
          clearTimeout(timeout);
          worker.removeEventListener("message", onReady);
          resolve();
        } else if (event.data.type === "error") {
          clearTimeout(timeout);
          worker.removeEventListener("message", onReady);
          reject(new Error(event.data.error));
        }
      });
    });
    console.log("[OPFS Initializer] Worker ready, getting capacity...");
    const capacityResult = await sendMessage("getCapacity");
    const fileListResult = await sendMessage("getFileList");
    isInitialized = true;
    console.log("[OPFS Initializer] Initialization complete");
    return {
      success: true,
      message: "OPFS Worker initialized successfully",
      capacity: capacityResult.capacity,
      fileCount: fileListResult.files.length
    };
  } catch (error) {
    console.error("[OPFS Initializer] Failed to initialize:", error);
    return {
      success: false,
      message: error instanceof Error ? error.message : "Unknown error"
    };
  }
}
function isReady() {
  return isInitialized;
}
async function getFileList() {
  const result = await sendMessage("getFileList");
  return result.files || [];
}
async function exportDatabase(filename) {
  const result = await sendMessage("readFile", { filename });
  return result.data;
}
async function importDatabase(filename, dataArray) {
  const result = await sendMessage("writeFile", { filename, data: dataArray });
  return result.bytesWritten;
}
async function deleteDatabase(filename) {
  const result = await sendMessage("deleteFile", { filename });
  return result.success;
}
async function getCapacity() {
  const result = await sendMessage("getCapacity");
  return result.capacity;
}
async function addCapacity(count) {
  const result = await sendMessage("addCapacity", { count });
  return result.newCapacity;
}
async function persist(filename) {
  console.log("[OPFS Persist] Starting persist for:", filename);
  if (!window.Blazor?.runtime?.Module?.FS) {
    throw new Error("Emscripten FS not available. Ensure WasmBuildNative=true is enabled.");
  }
  const fs = window.Blazor.runtime.Module.FS;
  const filePath = `/${filename}`;
  const pathInfo = fs.analyzePath(filePath);
  console.log("[OPFS Persist] File exists in MEMFS:", pathInfo.exists);
  if (!pathInfo.exists) {
    throw new Error(`Database file ${filename} not found in MEMFS`);
  }
  const data = fs.readFile(filePath);
  console.log("[OPFS Persist] Read from MEMFS:", data.length, "bytes");
  await sendMessage("writeFile", {
    filename,
    data: Array.from(data)
  });
  console.log("[OPFS Persist] Written to OPFS:", filename);
}
async function load(filename) {
  console.log("[OPFS Load] Starting load for:", filename);
  if (!window.Blazor?.runtime?.Module?.FS) {
    throw new Error("Emscripten FS not available. Ensure WasmBuildNative=true is enabled.");
  }
  const fs = window.Blazor.runtime.Module.FS;
  const filePath = `/${filename}`;
  try {
    const result = await sendMessage("readFile", { filename });
    console.log("[OPFS Load] Read from OPFS:", result.data?.length || 0, "bytes");
    if (result.data && result.data.length > 0) {
      fs.writeFile(filePath, new Uint8Array(result.data));
      console.log("[OPFS Load] Written to MEMFS:", filename);
    }
  } catch (error) {
    console.log(`[OPFS Load] Database ${filename} not found in OPFS (will be created on first use)`);
  }
}
async function cleanup() {
  if (worker) {
    console.log("[OPFS Initializer] Requesting cleanup...");
    try {
      await sendMessage("cleanup");
      console.log("[OPFS Initializer] Cleanup complete");
    } catch (e) {
      console.warn("[OPFS Initializer] Cleanup failed:", e);
    }
  }
}
console.log("[OPFS Initializer] Module loaded");
export {
  addCapacity,
  cleanup,
  deleteDatabase,
  exportDatabase,
  getCapacity,
  getFileList,
  importDatabase,
  initialize,
  isReady,
  load,
  persist
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vVHlwZXNjcmlwdC9vcGZzLWluaXRpYWxpemVyLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvLyBvcGZzLWluaXRpYWxpemVyLnRzXG4vLyBNYWluIHRocmVhZCB3cmFwcGVyIGZvciBPUEZTIFdvcmtlclxuLy8gSGFuZGxlcyBjb21tdW5pY2F0aW9uIHdpdGggb3Bmcy13b3JrZXIuanMgZm9yIGZpbGUgSS9PXG5cbmludGVyZmFjZSBJbml0aWFsaXplUmVzdWx0IHtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIG1lc3NhZ2U6IHN0cmluZztcbiAgICBjYXBhY2l0eT86IG51bWJlcjtcbiAgICBmaWxlQ291bnQ/OiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBXb3JrZXJNZXNzYWdlIHtcbiAgICBpZDogbnVtYmVyO1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBhcmdzPzogYW55O1xufVxuXG5pbnRlcmZhY2UgV29ya2VyUmVzcG9uc2Uge1xuICAgIGlkOiBudW1iZXI7XG4gICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICByZXN1bHQ/OiBhbnk7XG4gICAgZXJyb3I/OiBzdHJpbmc7XG59XG5cbmxldCB3b3JrZXI6IFdvcmtlciB8IG51bGwgPSBudWxsO1xubGV0IG1lc3NhZ2VJZCA9IDA7XG5sZXQgcGVuZGluZ01lc3NhZ2VzID0gbmV3IE1hcDxudW1iZXIsIHsgcmVzb2x2ZTogRnVuY3Rpb247IHJlamVjdDogRnVuY3Rpb24gfT4oKTtcbmxldCBpc0luaXRpYWxpemVkID0gZmFsc2U7XG5cbmZ1bmN0aW9uIHNlbmRNZXNzYWdlKHR5cGU6IHN0cmluZywgYXJncz86IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgaWYgKCF3b3JrZXIpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignV29ya2VyIG5vdCBpbml0aWFsaXplZCcpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBpZCA9IG1lc3NhZ2VJZCsrO1xuICAgICAgICBwZW5kaW5nTWVzc2FnZXMuc2V0KGlkLCB7IHJlc29sdmUsIHJlamVjdCB9KTtcblxuICAgICAgICBjb25zdCBtZXNzYWdlOiBXb3JrZXJNZXNzYWdlID0geyBpZCwgdHlwZSwgYXJncyB9O1xuICAgICAgICB3b3JrZXIhLnBvc3RNZXNzYWdlKG1lc3NhZ2UpO1xuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpOiBQcm9taXNlPEluaXRpYWxpemVSZXN1bHQ+IHtcbiAgICBpZiAoaXNJbml0aWFsaXplZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdBbHJlYWR5IGluaXRpYWxpemVkJ1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBJbml0aWFsaXplcl0gQ3JlYXRpbmcgd29ya2VyLi4uJyk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHdvcmtlciBmcm9tIGJ1bmRsZWQgd29ya2VyIGZpbGVcbiAgICAgICAgd29ya2VyID0gbmV3IFdvcmtlcihcbiAgICAgICAgICAgICcvX2NvbnRlbnQvU1FMaXRlTkVULk9wZnMvb3Bmcy13b3JrZXIuanMnLFxuICAgICAgICAgICAgeyB0eXBlOiAnbW9kdWxlJyB9XG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gU2V0IHVwIG1lc3NhZ2UgaGFuZGxlclxuICAgICAgICB3b3JrZXIub25tZXNzYWdlID0gKGV2ZW50OiBNZXNzYWdlRXZlbnQ8V29ya2VyUmVzcG9uc2U+KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGlkLCBzdWNjZXNzLCByZXN1bHQsIGVycm9yIH0gPSBldmVudC5kYXRhO1xuXG4gICAgICAgICAgICBjb25zdCBwZW5kaW5nID0gcGVuZGluZ01lc3NhZ2VzLmdldChpZCk7XG4gICAgICAgICAgICBpZiAocGVuZGluZykge1xuICAgICAgICAgICAgICAgIHBlbmRpbmdNZXNzYWdlcy5kZWxldGUoaWQpO1xuICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmcucmVqZWN0KG5ldyBFcnJvcihlcnJvciB8fCAnVW5rbm93biBlcnJvcicpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQ2xlYW4gdXAgaGFuZGxlcyBiZWZvcmUgcGFnZSB1bmxvYWRcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsICgpID0+IHtcbiAgICAgICAgICAgIGlmICh3b3JrZXIpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAvLyBTZW5kIHN5bmNocm9ub3VzIGNsZWFudXAgbWVzc2FnZSAoYmVzdCBlZmZvcnQpXG4gICAgICAgICAgICAgICAgICAgIHdvcmtlci5wb3N0TWVzc2FnZSh7IGlkOiAtMSwgdHlwZTogJ2NsZWFudXAnIH0pO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdbT1BGUyBJbml0aWFsaXplcl0gQ291bGQgbm90IHNlbmQgY2xlYW51cCBtZXNzYWdlOicsIGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gV2FpdCBmb3Igd29ya2VyIHJlYWR5IHNpZ25hbFxuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKCdXb3JrZXIgaW5pdGlhbGl6YXRpb24gdGltZW91dCcpKSwgMTAwMDApO1xuXG4gICAgICAgICAgICB3b3JrZXIhLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBmdW5jdGlvbiBvblJlYWR5KGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEudHlwZSA9PT0gJ3JlYWR5Jykge1xuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIHdvcmtlciEucmVtb3ZlRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uUmVhZHkpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5kYXRhLnR5cGUgPT09ICdlcnJvcicpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICB3b3JrZXIhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBvblJlYWR5KTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihldmVudC5kYXRhLmVycm9yKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBJbml0aWFsaXplcl0gV29ya2VyIHJlYWR5LCBnZXR0aW5nIGNhcGFjaXR5Li4uJyk7XG5cbiAgICAgICAgLy8gR2V0IGluaXRpYWwgY2FwYWNpdHkgYW5kIGZpbGUgY291bnRcbiAgICAgICAgY29uc3QgY2FwYWNpdHlSZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZ2V0Q2FwYWNpdHknKTtcbiAgICAgICAgY29uc3QgZmlsZUxpc3RSZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZ2V0RmlsZUxpc3QnKTtcblxuICAgICAgICBpc0luaXRpYWxpemVkID0gdHJ1ZTtcblxuICAgICAgICBjb25zb2xlLmxvZygnW09QRlMgSW5pdGlhbGl6ZXJdIEluaXRpYWxpemF0aW9uIGNvbXBsZXRlJyk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBtZXNzYWdlOiAnT1BGUyBXb3JrZXIgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5JyxcbiAgICAgICAgICAgIGNhcGFjaXR5OiBjYXBhY2l0eVJlc3VsdC5jYXBhY2l0eSxcbiAgICAgICAgICAgIGZpbGVDb3VudDogZmlsZUxpc3RSZXN1bHQuZmlsZXMubGVuZ3RoXG4gICAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignW09QRlMgSW5pdGlhbGl6ZXJdIEZhaWxlZCB0byBpbml0aWFsaXplOicsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcidcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1JlYWR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBpc0luaXRpYWxpemVkO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZUxpc3QoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbmRNZXNzYWdlKCdnZXRGaWxlTGlzdCcpO1xuICAgIHJldHVybiByZXN1bHQuZmlsZXMgfHwgW107XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleHBvcnREYXRhYmFzZShmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXJbXT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbmRNZXNzYWdlKCdyZWFkRmlsZScsIHsgZmlsZW5hbWUgfSk7XG4gICAgcmV0dXJuIHJlc3VsdC5kYXRhO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW1wb3J0RGF0YWJhc2UoZmlsZW5hbWU6IHN0cmluZywgZGF0YUFycmF5OiBudW1iZXJbXSk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VuZE1lc3NhZ2UoJ3dyaXRlRmlsZScsIHsgZmlsZW5hbWUsIGRhdGE6IGRhdGFBcnJheSB9KTtcbiAgICByZXR1cm4gcmVzdWx0LmJ5dGVzV3JpdHRlbjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZURhdGFiYXNlKGZpbGVuYW1lOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZGVsZXRlRmlsZScsIHsgZmlsZW5hbWUgfSk7XG4gICAgcmV0dXJuIHJlc3VsdC5zdWNjZXNzO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q2FwYWNpdHkoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgnZ2V0Q2FwYWNpdHknKTtcbiAgICByZXR1cm4gcmVzdWx0LmNhcGFjaXR5O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWRkQ2FwYWNpdHkoY291bnQ6IG51bWJlcik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VuZE1lc3NhZ2UoJ2FkZENhcGFjaXR5JywgeyBjb3VudCB9KTtcbiAgICByZXR1cm4gcmVzdWx0Lm5ld0NhcGFjaXR5O1xufVxuXG4vKipcbiAqIFBlcnNpc3QgYSBkYXRhYmFzZSBmaWxlIGZyb20gRW1zY3JpcHRlbiBNRU1GUyB0byBPUEZTLlxuICogUmVhZHMgdGhlIGZpbGUgZnJvbSBuYXRpdmUgV0FTTSBtZW1vcnkgYW5kIHN0b3JlcyBpdCBpbiBPUEZTLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGVyc2lzdChmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc29sZS5sb2coJ1tPUEZTIFBlcnNpc3RdIFN0YXJ0aW5nIHBlcnNpc3QgZm9yOicsIGZpbGVuYW1lKTtcblxuICAgIC8vIENoZWNrIGlmIGZpbGUgZXhpc3RzIGluIEVtc2NyaXB0ZW4gTUVNRlNcbiAgICBpZiAoISh3aW5kb3cgYXMgYW55KS5CbGF6b3I/LnJ1bnRpbWU/Lk1vZHVsZT8uRlMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXNjcmlwdGVuIEZTIG5vdCBhdmFpbGFibGUuIEVuc3VyZSBXYXNtQnVpbGROYXRpdmU9dHJ1ZSBpcyBlbmFibGVkLicpO1xuICAgIH1cblxuICAgIGNvbnN0IGZzID0gKHdpbmRvdyBhcyBhbnkpLkJsYXpvci5ydW50aW1lLk1vZHVsZS5GUztcbiAgICBjb25zdCBmaWxlUGF0aCA9IGAvJHtmaWxlbmFtZX1gO1xuXG4gICAgY29uc3QgcGF0aEluZm8gPSBmcy5hbmFseXplUGF0aChmaWxlUGF0aCk7XG4gICAgY29uc29sZS5sb2coJ1tPUEZTIFBlcnNpc3RdIEZpbGUgZXhpc3RzIGluIE1FTUZTOicsIHBhdGhJbmZvLmV4aXN0cyk7XG5cbiAgICBpZiAoIXBhdGhJbmZvLmV4aXN0cykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGFiYXNlIGZpbGUgJHtmaWxlbmFtZX0gbm90IGZvdW5kIGluIE1FTUZTYCk7XG4gICAgfVxuXG4gICAgLy8gUmVhZCBmcm9tIE1FTUZTXG4gICAgY29uc3QgZGF0YSA9IGZzLnJlYWRGaWxlKGZpbGVQYXRoKTtcbiAgICBjb25zb2xlLmxvZygnW09QRlMgUGVyc2lzdF0gUmVhZCBmcm9tIE1FTUZTOicsIGRhdGEubGVuZ3RoLCAnYnl0ZXMnKTtcblxuICAgIC8vIFdyaXRlIHRvIE9QRlMgdmlhIHdvcmtlclxuICAgIGF3YWl0IHNlbmRNZXNzYWdlKCd3cml0ZUZpbGUnLCB7XG4gICAgICAgIGZpbGVuYW1lLFxuICAgICAgICBkYXRhOiBBcnJheS5mcm9tKGRhdGEpXG4gICAgfSk7XG5cbiAgICBjb25zb2xlLmxvZygnW09QRlMgUGVyc2lzdF0gV3JpdHRlbiB0byBPUEZTOicsIGZpbGVuYW1lKTtcbn1cblxuLyoqXG4gKiBMb2FkIGEgZGF0YWJhc2UgZmlsZSBmcm9tIE9QRlMgdG8gRW1zY3JpcHRlbiBNRU1GUy5cbiAqIFJlYWRzIHRoZSBmaWxlIGZyb20gT1BGUyBhbmQgd3JpdGVzIGl0IHRvIG5hdGl2ZSBXQVNNIG1lbW9yeS5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWQoZmlsZW5hbWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnNvbGUubG9nKCdbT1BGUyBMb2FkXSBTdGFydGluZyBsb2FkIGZvcjonLCBmaWxlbmFtZSk7XG5cbiAgICBpZiAoISh3aW5kb3cgYXMgYW55KS5CbGF6b3I/LnJ1bnRpbWU/Lk1vZHVsZT8uRlMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXNjcmlwdGVuIEZTIG5vdCBhdmFpbGFibGUuIEVuc3VyZSBXYXNtQnVpbGROYXRpdmU9dHJ1ZSBpcyBlbmFibGVkLicpO1xuICAgIH1cblxuICAgIGNvbnN0IGZzID0gKHdpbmRvdyBhcyBhbnkpLkJsYXpvci5ydW50aW1lLk1vZHVsZS5GUztcbiAgICBjb25zdCBmaWxlUGF0aCA9IGAvJHtmaWxlbmFtZX1gO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgLy8gUmVhZCBmcm9tIE9QRlMgdmlhIHdvcmtlclxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kTWVzc2FnZSgncmVhZEZpbGUnLCB7IGZpbGVuYW1lIH0pO1xuICAgICAgICBjb25zb2xlLmxvZygnW09QRlMgTG9hZF0gUmVhZCBmcm9tIE9QRlM6JywgcmVzdWx0LmRhdGE/Lmxlbmd0aCB8fCAwLCAnYnl0ZXMnKTtcblxuICAgICAgICBpZiAocmVzdWx0LmRhdGEgJiYgcmVzdWx0LmRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgLy8gV3JpdGUgdG8gTUVNRlNcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZShmaWxlUGF0aCwgbmV3IFVpbnQ4QXJyYXkocmVzdWx0LmRhdGEpKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBMb2FkXSBXcml0dGVuIHRvIE1FTUZTOicsIGZpbGVuYW1lKTtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIERhdGFiYXNlIGRvZXNuJ3QgZXhpc3QgaW4gT1BGUyB5ZXQgLSB0aGlzIGlzIG9rYXkgKHdpbGwgYmUgY3JlYXRlZClcbiAgICAgICAgY29uc29sZS5sb2coYFtPUEZTIExvYWRdIERhdGFiYXNlICR7ZmlsZW5hbWV9IG5vdCBmb3VuZCBpbiBPUEZTICh3aWxsIGJlIGNyZWF0ZWQgb24gZmlyc3QgdXNlKWApO1xuICAgIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNsZWFudXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHdvcmtlcikge1xuICAgICAgICBjb25zb2xlLmxvZygnW09QRlMgSW5pdGlhbGl6ZXJdIFJlcXVlc3RpbmcgY2xlYW51cC4uLicpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgc2VuZE1lc3NhZ2UoJ2NsZWFudXAnKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbT1BGUyBJbml0aWFsaXplcl0gQ2xlYW51cCBjb21wbGV0ZScpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ1tPUEZTIEluaXRpYWxpemVyXSBDbGVhbnVwIGZhaWxlZDonLCBlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuY29uc29sZS5sb2coJ1tPUEZTIEluaXRpYWxpemVyXSBNb2R1bGUgbG9hZGVkJyk7XG4iXSwKICAibWFwcGluZ3MiOiAiO0FBd0JBLElBQUksU0FBd0I7QUFDNUIsSUFBSSxZQUFZO0FBQ2hCLElBQUks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
